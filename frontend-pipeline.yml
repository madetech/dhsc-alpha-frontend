# Docker

# Build and push an image to Azure Container Registry
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
    - main

resources:
    - repo: self

variables:
# Container registry service connection established during pipeline creation
- group: acr_service_connection
- group: arm_service_connection
- name: imageRepository
  value: 'dapalpha'
- name: dockerfilePath
  value: '$(Build.SourcesDirectory)/app/Dockerfile'
- name: tag
  value: '$(Build.BuildId)'
- name: vmImageName
  value: 'ubuntu-latest'

parameters:
- name: environments
  type: object
  default:
  - name: dev
    arm_connection: '$(dev_arm_service_connections)'
    acr_connection: '$(dev_acr_connection)'
    acr_name: '$(dev_acr_name)'
  - name: prod
    arm_connection: '$(prod_arm_service_connections)'
    acr_connection: '$(prod_acr_connection)'
    acr_name: '$(prod_acr_name)'


stages:
    - stage: Test
      displayName: Run tests
      jobs:
          - job: Test
            displayName: Run unit tests
            pool:
                vmImage: $(vmImageName)
            steps:
                - script: |
                      cd app
                      echo "Running npm ci..."
                      npm ci
                  displayName: 'Install dependencies'
                - script: |
                      cd app
                      echo "Running tests..."
                      npm test -- --watchAll=false --coverage
                  displayName: 'Run tests'
    - ${{ each environment in parameters.environments}}:
        - stage: Build_${{environment.name}}
          displayName: Build and push stage
          dependsOn: Test
          condition: succeeded('Test')
          jobs:
              - deployment: Build
                displayName: Build
                environment: '${{environment.name}}'
                pool:
                    vmImage: $(vmImageName)
                strategy:
                    runOnce:
                        deploy:
                            steps:
                            - task: Docker@2
                              displayName: Build and push an image to container registry
                              inputs:
                                  command: buildAndPush
                                  repository: $(imageRepository)
                                  dockerfile: $(dockerfilePath)
                                  containerRegistry: ${{environment.acr_connection}}
                                  tags: |
                                      $(tag)
                                      latest
        - stage: Deploy_${{environment.name}}
          displayName: Deploy to Azure Web App
          dependsOn: Build_${{environment.name}}
          condition: succeeded()
          jobs:
              - deployment: Deploy
                displayName: Deploy
                environment: '${{environment.name}}'
                pool:
                    vmImage: 'ubuntu-latest'
                strategy:
                    runOnce:
                        deploy:
                            steps:
                                - task: AzureWebAppContainer@1
                                  inputs:
                                      appType: 'webAppLinux'
                                      appName: 'dapalpha-${{environment.name}}-app'
                                      azureSubscription: ${{environment.arm_connection}}
                                      containers: '${{environment.acr_name}}.azurecr.io/$(imageRepository):$(tag)'
